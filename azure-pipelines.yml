trigger:
  branches:
    include:
    - main

pr:
  branches:
    include:
    - main

jobs:
- job: daalp4yPyP
  strategy:
    matrix:
      ubuntu:
        imageName: 'ubuntu-20.04'
  pool:
    vmImage: $(imageName)
  steps:
  - script: |
      wget https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS-2023.PUB
      sudo apt-key add GPG-PUB-KEY-INTEL-SW-PRODUCTS-2023.PUB
      rm GPG-PUB-KEY-INTEL-SW-PRODUCTS-2023.PUB
      echo "deb https://apt.repos.intel.com/oneapi all main" | sudo tee /etc/apt/sources.list.d/oneAPI.list
      sudo add-apt-repository -y "deb https://apt.repos.intel.com/oneapi all main"
      sudo apt-get update
      sudo apt-get install                  \
          intel-oneapi-common-vars          \
          intel-oneapi-common-licensing     \
          intel-oneapi-dpcpp-cpp-compiler   \
          intel-oneapi-dev-utilities        \
          intel-oneapi-libdpstd-devel
      sudo bash -c 'echo libintelocl.so > /etc/OpenCL/vendors/intel-cpu.icd'
      sudo mv -f /opt/intel/oneapi/compiler/latest/linux/lib/oclfpga /opt/intel/oneapi/compiler/latest/linux/lib/oclfpga_
    displayName: 'apt-get'
  - script: |
      conda update -q -y conda
      conda create -q -y -n CB -c intel python=3.7 daal4py scikit-learn
      pip install pytest pandas
    displayName: 'Install daal4py'
  - script: |
      . /usr/share/miniconda/etc/profile.d/conda.sh
      conda activate CB
      export DPCPPROOT=/opt/intel/oneapi/compiler/latest
      source ${DPCPPROOT}/env/vars.sh
      python -c "import daal4py"
      git clone https://github.com/IntelPython/daal4py.git
      cd daal4py
      python examples/run_examples.py
      python -m daal4py examples/sycl/sklearn_sycl.py
    displayName: 'Testing daal4py'
